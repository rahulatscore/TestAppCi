version: 2
jobs:
  test_build:
    working_directory: ~/code
    docker:
      - image: circleci/android:api-28
    environment:
      JVM_OPTS: -Xmx3200m
    steps:
      - checkout
      - restore_cache:
          key: jars-{{ checksum "build.gradle" }}-{{ checksum  "app/build.gradle" }}
      - run:
          name: Download Dependencies
          command: ./gradlew androidDependencies
      - save_cache:
          paths:
            - ~/.gradle
          key: jars-{{ checksum "build.gradle" }}-{{ checksum  "app/build.gradle" }}
      - run:
          name: Run Tests
          command: ./gradlew lint testDebugUnitTest  
      - store_artifacts: # for display in Artifacts: https://circleci.com/docs/2.0/artifacts/
          path: app/build/reports 
          destination: reports/lint
      - store_test_results: # for display in Test Summary: https://circleci.com/docs/2.0/collect-test-data/
          path: app/build/reports/tests
          destination: eports/test-results
      - run:
          name: Run Code Coverage
          command: ./gradlew jacocoTestCoverageVerification --stacktrace  
      - store_artifacts: # for display in Artifacts: https://circleci.com/docs/2.0/artifacts/
          path: build/coverage-report 
          destination: reports/coverage
  debug_build:
    working_directory: ~/code
    docker:
      - image: circleci/android:api-28
    environment:
      JVM_OPTS: -Xmx3200m
    steps:
      - checkout
      - restore_cache:
          key: jars-{{ checksum "build.gradle" }}-{{ checksum  "app/build.gradle" }}
      - run:
          name: Debug build
          command: ./gradlew clean assembleDebug --no-daemon --stacktrace
      - store_artifacts:
          path: app/build/outputs/apk/
          destination: apks/     
  rc_build:
    working_directory: ~/code
    docker:
      - image: circleci/android:api-28
    environment:
      JVM_OPTS: -Xmx3200m
    steps:
      - checkout
      - restore_cache:
          key: jars-{{ checksum "build.gradle" }}-{{ checksum  "app/build.gradle" }}
      - run:
          name: Release build
          command: ./gradlew clean assembleRelease --no-daemon --stacktrace
      - store_artifacts:
          path: app/build/outputs/apk/
          destination: apks/ 
  danger_check:
    working_directory: ~/danger
    docker:
    - image: circleci/android:api-28
      environment:
      JVM_OPTS: -Xmx3200m
    steps:
    - checkout
    - run: gem update --system 2.5
    - run: gem install bundler
    - restore_cache:
        key: gem-cache-{{ .Branch }}-{{ checksum "Gemfile" }}
    - run: bundle install --path vendor/bundle
    - save_cache:
        key: gem-cache-{{ .Branch }}-{{ checksum "Gemfile" }}
        paths:
        - vendor/bundle
    - run: git config --global user.email "rahul.patel@thescore.com"
    - run: git config --global user.name "Rahul Patel"
    - run: bundle exec rake specs
    - run: '[ ! -z $DANGER_GITHUB_API_TOKEN ] && bundle exec danger || echo "Skipping Danger for External Contributor"'
    - run: bundle exec danger init --mousey --impatient
workflows:
  version: 2
  workflow:
    jobs:
      - danger_check
      - test_build
      - debug_build:
          requires:
            - test_build
          filters:
            branches:
              only:
                - dev
                - master
      - rc_build:
          type: approval
          requires:
            - test_build
          filters:
            branches:
              only: 
                - master